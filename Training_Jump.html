<!doctype html>
<!-- Example taken from http://www.jspsych.org/tutorials/rt-task/ and adapted for the use with JATOS -->
<html lang="en">

<head>
    <title>Training Jumping Dots</title>
    <!-- If you use an older version of JATOS (< 3.3.1) you have to use absolutes path for you assets and jatos.js-->
    <script src="jspsych-6.0.4/jspsych.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
    <!-- custom scripts -->
    <script src="jspsych-6.0.4/plugins/custom-html-button-response-conditional.js"></script>
    <script src="jspsych-6.0.4/plugins/custom-manual-inhibition-jump.js"></script> 
    <link href="styles.css" rel="stylesheet" type="text/css">
    <script src="objects.js"></script>
    <script type= "text/javascript" src="loops.js"></script>
    <script src="common_vars.js"></script>
    <!-- jatos import -->
    <script src="jatos.js"></script>
    <!-- css import -->
    <link href="jspsych-6.0.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <!-- meta prevents zooming in -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" >

</head>

<body bgcolor='gray'>

    <script>

        // salute the hacker
        console.log("You're still around. That's awesome.");

        // this script is a shortened version of the full experiment.
        // The difference is that we do less trials

        // define parameter values for the experiment:
        let nTrials = 1; // the number of trials per condition
        let cFlash = [0,1]; // the flash conditions
        let cJump = [0,1]; // the jump conditions
        let cInwards = [0,1]; // inward/not condition
        let cPosition = ['l','r']; // the position condition
        let fixTime = 1000; // how long the central point is maximally touched before the trial starts
        let flashTime = 250; // the longest time till the flash occurs after trial start
        let trialDur = 1000; // the duration of the experiment (without fixation time)
        let waitAfter = 500; // time to wait after each trial
        let flashDur = 30; // how long to display the flash in ms

        let test_stimuli = Jump_loop(nTrials, cFlash, cJump, cInwards, cPosition, fixTime, flashTime, trialDur);

        // core trial structure
        let trial = {
            type: 'manual-inhibition-jump', // calls the custom plugin
            centralPoint: centralPoint, // the central point is the same for all trials
            centralButton: invisibleCentralPoint, // the central button is the same for all trials
            sidePoint: jsPsych.timelineVariable('sidePoint'), // the side point is either left or right
            jumpedPoint: jsPsych.timelineVariable('jumpedPoint'), // the jumped point is either left or right and forwards or backwards
            sideButton: jsPsych.timelineVariable('sideButton'), // the side button is either left or right
            flashUp: jsPsych.timelineVariable('flashUp'), // the upper flash is either visible or invisible
            flashDown: jsPsych.timelineVariable('flashDown'), // the lower flash is either visible or invisible
            fixTime: jsPsych.timelineVariable('fixTime'), // the fixation time is a random value between 0 and 1000 ms
            flashTime: jsPsych.timelineVariable('flashTime'), // the flash time is a random value between 0 and 250 ms
            trialDuration: jsPsych.timelineVariable('trialDuration'), // the trial duration is 1000 ms after the first jump
            flashDuration: flashDur, // the flash is shown for 30 ms in each trial
            waitAfter: waitAfter, // the trial waits 500 ms before presenting feedback
            runTrial: function() {
                // this function defines on each trial if it should run or not
                // get the ID of the current trial
                let id_here = jsPsych.timelineVariable('trialID', true);
                // repeat_trials is empty till the first loop completed
                if (repeat_trials.length > 0) {
                    // check if the current trial ID was included in the repetition list
                    repeat = repeat_trials.includes(id_here);
                } else {
                    // if the repetition list is empty, we are in the first loop and run every trial
                    repeat =  true;
                }
                return repeat;
                },

            // save the data from the current trial
            // the "true" extension evaluates the timeline Variable immediately
            data: {
                test_part: 'trial',
                position: jsPsych.timelineVariable('position'),
                stimJumped: jsPsych.timelineVariable('stimJumps'),
                flashShown: jsPsych.timelineVariable('showFlash'),
                inwards: jsPsych.timelineVariable('inwards'),
                fixTime: jsPsych.timelineVariable('fixTime'),
                flashTime: jsPsych.timelineVariable('flashTime'),
                trialDuration: jsPsych.timelineVariable('trialDuration'),
                trialID: jsPsych.timelineVariable('trialID'),
            },
            // this function is executed after each trial
            on_finish: function (data){
                // check if the response was given too early
                earlyResponse = data.earlyResponse;
                // check if the response was given too late
                lateResponse = data.lateResponse;
                // save a repetition value for the feedback trial
                repeat = data.trialShown;

                // if the response was early or late and the trial was presented in the firs place,
                // save the ID of the trial
                if (data.trialShown){
                    if (lateResponse || earlyResponse){
                    T = jsPsych.timelineVariable("trialID", true);
                    repeat_IDs.push(T);
                    }
                }
            },
        };

        // feedback displayed after every trial
        let feedback = {
            type: 'html-button-response-conditional',
            stimulus: function () {
                // evaluate the last trial, and adjust the stimulus that will be returned
                if (earlyResponse) {
                    return "<p>Please keep you finger at fixation till the point jumps!</p>"
                } else if (lateResponse) {
                    return "<p>Too slow!</p>"
                } else {
                    return "<p>Well Done.</p>"
                }
            },
            post_trial_gap: 0, // needs to be zero to avoid waiting times when the trial is skipped
            choices: [''], // don't display choices
            button_html: '', // don't display buttons
            trial_duration: 1500, // display the feedback for 1500 ms
            runTrial: function(){return repeat}, // evaluate if the trial should run or not
            data:{
                test_part: 'feedback',
            },
        };

        // define a training procedure
        let test_procedure = {
            timeline: [trial, feedback], // one trial and one feedback will be repeated after each other
            timeline_variables: test_stimuli, // our design structure provides the timeline variables
            repetitions: 1, // our design structure is repeated once
            randomize_order: true, // the order of trials is random
            // this function evaluates if we want to repeat the loop
            // if it evaluates to true, we repeat the full design matrix
            loop_function: function(){
                // save the IDs to be repeated in a new variable
                repeat_trials = repeat_IDs;
                // check if there are any IDs to repeat
                let eval_loop = repeat_IDs.length > 0;
                // reset the repetition array to empty
                repeat_IDs = [];
                // return true or false
                return eval_loop
            },
        };
        timeline.push(test_procedure);


        // let them know that the training is over
        let end_instructions = {
            type: 'instructions',
            pages: ["<p>That's the end of the training block.</p>" +
            "<p>Let's start the first part of experiment.</p>"],
            show_clickable_nav: true,
            button_label_next: 'Ok. Continue >',
            post_trial_gap: 200,
            data: {
                test_part: 'intro',
            }
        };
        timeline.push(end_instructions);

        // start the experiment
        jatos.onLoad(function() {

            jsPsych.data.addProperties({
            subject: jatos.workerId,
            screenWidth: screen.width,
            screenHeight: screen.height,
            userInfo: navigator.userAgent,
            platform: navigator.platform,
            scrPixDepth: screen.pixelDepth,
            scrColDepth : screen.colorDepth,
            scrOrientation: orientation,
            scrResolution: window.devicePixelRatio,
            component: 'Training_Jump',
            });

            jsPsych.init({
                timeline: timeline,
                fullscreen: true,
                on_finish: function() {
                    let resultJson = jsPsych.data.get().json();
                    jatos.submitResultData(resultJson, jatos.startNextComponent);
                }
            });
        });
    </script>
</body>


</html>