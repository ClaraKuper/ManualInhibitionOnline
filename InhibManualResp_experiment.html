<!doctype html>
<!-- Example taken from http://www.jspsych.org/tutorials/rt-task/ and adapted for the use with JATOS -->
<html lang="de">

<head>
    <title>Pointing experiment</title>
    <!-- If you use an older version of JATOS (< 3.3.1) you have to use absolutes path for you assets and jatos.js-->
    <script src="jspsych-6.0.4/jspsych.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-button-response-touchdown.js"></script>
    <script src="jatos.js"></script>
    <link href="jspsych-6.0.4/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <style> .stimulus { font-size: 32px; } </style>
</head>

<body bgcolor='gray'>
    <script>

        // event handler function for mouse down clicks
        let xyCoords = {};

        function handler(e) {
            e = e || window.event;

            var pageX = e.pageX;
            var pageY = e.pageY;

            // IE 8
            if (pageX === undefined) {
                pageX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                pageY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
            }

            xyCoords.X = pageX;
            xyCoords.Y = pageY;
        };

        // attach handler to the mousedown event of the document
        if (document.attachEvent) document.attachEvent('ontouchstart', handler);
        else document.addEventListener('touchstart', handler);

        function increment(n){
                n++;
                return n;
        }

        /* create timeline */
        let timeline = [];
        let responseGiven = null;
        let timer = {};
        let trial_nr = 0;

        let scrWidth = screen.width;
        let scrHeight = screen.height;

        /* define welcome message trial */
        let welcome = {
            type: "fullscreen",
            message:["<p>Welcome to the experiment!</p>" +
            "<p>&nbsp;</p>"+
            "<p> Press the button below to switch to fullscreen and continue.</p>"],
            fullscreen_mode: true,
            data: {
                test_part: 'welcome',
                scrWidth: scrWidth,
                scrHeight: scrHeight,
            }
        };
        timeline.push(welcome);

        /* define instructions trial */
        let general_intro = {
            type: "instructions",
            pages: ["<p>This experiment should be conducted on a touchscreen in landscape mode (tablet, smartphone or alike).</p>" +
                "<p> Please make sure you are comfortable and nothing distracts you. The experiment lasts about 15 minutes and you shouldn't </p>" +
                "<p> close the tab during the experiment. You can take breaks whenever you see the central fixation point appear on the screen </p>" +
                "<p> (dark gray point in the center). You are also free to end the experiment whenever you want, you data will only be saved </p>"+
                "<p> if you complete the full experiment.</p>"+
                "<p>&nbsp;</p>"+
                "<p>Press continue to get to the detailed instructions.</p>",
                "<p>In this experiment, a dark grey dot (fixation point) will appear in the center of the screen. Please tap on that dot with your index finger.</p>" +
                "<p> This will start the trial. In each trial, the fixation point turns black, and jumps to the left or to the right. When it jumps,</p>" +
                "<p> try to tap it at it's new location as quickly and accurately as possible. Sometimes, the upper and lower part of the screen will </p>" +
                "<p> turn white, producing a flash. Please ignore that flash - it has no relevance for the task.</p>" +
                "<p> Sometimes, a the point will jump a second time. If it does, try to touch it at the new position. But be aware! You only have</p>" +
                "<p> a limited time to finish the trial. When you wait for too long, you'll be late. Speed is more important than precision. </p>" +
                "<p>&nbsp;</p>"+
                "<p> Press continue.</p>",
                "<p> We will start with a small training block.</p>" +
                "<p> The training block has the same timing as the experiment itself. </p>" +
                "<p> &nbsp;</p>"+
                "<p> Press continue to begin training.</p>"],
            show_clickable_nav: true,
            button_label_next: 'continue',
            post_trial_gap: 1000,
            data: {
                test_part: 'intro',
            }
        };
        timeline.push(general_intro);

        /*
        let instructions = {
            type: 'instructions',
            pages: ["<p>In this experiment, a dark grey dot (fixation point) will appear in the center of the screen. Please tap on that dot with your index finger.</p>" +
                "<p> This will start the trial. In each trial, the fixation point turns black, and jumps to the left or to the right. When it jumps,</p>" +
                "<p> try to tap it at it's new location as quickly and accurately as possible. Sometimes, the upper and lower part of the screen will </p>" +
                "<p> turn white, producing a flash. Please ignore that flash - it has no relevance for the task.</p>" +
                "<p> Sometimes, a the point will jump a second time. If it does, try to touch it at the new position. But be aware! You only have</p>" +
                "<p> a limited time to finish the trial. When you wait for too long, you'll be late. Speed is more important than precision. </p>" +
                "<p>&nbsp;</p>"+
                "<p> Press Continue to begin.</p>"],
            show_clickable_nav: true,
            button_label_next: 'Continue',
            post_trial_gap: 1000,
            data: {
                test_part: 'intro',
            }
        };
        timeline.push(instructions);*/

        /* define stimulus looks */
        let fixationPoint = "<div style = 'position:absolute; left:50%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #3f3f3f;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let centralPoint = "<div style = 'position:absolute; left:50%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let rightTar = "<div style = 'position:absolute; right:20%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        // invisible right tar let rightTarInvisible

        let rightTarInvisible = "<div id='rectangle' style='position:absolute; left:50%; top:0;" +
                "width:50%; height:100%; background-color:rgba(153,31,35,0);'></div>";

        let leftTar = "<div style = 'position:absolute; left:20%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        // invisible left Tar let leftTarInvisible

        let leftTarInvisible = "<div id='rectangle' style='position:absolute; right:50%; top:0;" +
                "width:50%; height:100%; background-color:rgba(153,31,35,0);'></div>";

        let rightTarShiftIn =  "<div style = 'position:absolute; right:24%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let rightTarShiftOut =  "<div style = 'position:absolute; right:16%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let leftTarShiftIn = "<div style = 'position:absolute; left:24%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let leftTarShiftOut = "<div style = 'position:absolute; left:16%; top:50%; height: 50px;" +
                "  width: 50px;" +
                "  background-color: #000000;" +
                "  border-radius: 50%;" +
                "  margin-top: -(50/2)px;" +
                "  margin-left: -(50/2)px;'>" +
                "<span class=dot ></span>";

        let flashVisible = "<div id='rectangle' style='position:absolute; left:0; top:0;" +
                "width:100%; height:33%; background-color:#ffffff;'></div>" +
                "<div id='rectangle' style='position:absolute; left:0; bottom:0;" +
                "width:100%; height:33%; background-color:#ffffff;'></div>" +
                "<div id ='dot' style='position:absolute; right:50%'></div>";

        let flashInvisible = "<div id='rectangle' style=' position:absolute; left:0; top:0;" +
                "width:100%; height:33%; background-color:#808080;'></div>" +
                "<div id='rectangle' style=' position:absolute; left:0; bottom:0;" +
                "width:100%; height:33%; background-color:#808080;'></div>";


        /* test trials */
        let test_stimuli = [

            // trial type 1: target right, flash, and shift inwards
            {
                stimulus: rightTar,
                jumpedStim: rightTarShiftIn,
                responseButton: rightTarInvisible,
                flash: flashVisible,
                position: 'r',
                shift: 1,
                inwards: 1,
                flashshown: 1,

        },
            // trial type 1.2: target right, flash, and shift outwards
            {
                stimulus: rightTar,
                jumpedStim: rightTarShiftOut,
                responseButton: rightTarInvisible,
                flash: flashVisible,
                position: 'r',
                shift: 1,
                inwards: 0,
                flashshown: 1,
        },

            // trial type 2: target right, flash, no shift
            {
                stimulus: rightTar,
                jumpedStim: rightTar,
                responseButton: rightTarInvisible,
                flash: flashVisible,
                position: 'r',
                shift: 0,
                inwards: null,
                flashshown: 1,

        },
            // trial type 3.1: target right, no flash, shift inwards
            {
                stimulus: rightTar,
                jumpedStim: rightTarShiftIn,
                responseButton: rightTarInvisible,
                flash: flashInvisible,
                position: 'r',
                shift: 1,
                inwards: 1,
                flashshown: 0,
            },

            // trial type 3.2: target right, no flash, shift outwards
            {
                stimulus: rightTar,
                jumpedStim: rightTarShiftOut,
                responseButton: rightTarInvisible,
                flash: flashInvisible,
                position: 'r',
                shift: 1,
                inwards: 0,
                flashshown: 0,
        },

            // trial type 4: target right, no flash, no shift
            {
                stimulus: rightTar,
                jumpedStim: rightTar,
                responseButton: rightTarInvisible,
                flash: flashInvisible,
                position: 'r',
                shift: 0,
                inwards: null,
                flashshown: 0,
        },

            // trial type 5.1: target left, flash, shift inwards
            {
                stimulus: leftTar,
                jumpedStim: leftTarShiftIn,
                responseButton: leftTarInvisible,
                flash: flashVisible,
                position: 'l',
                shift: 1,
                inwards: 1,
                flashshown: 1,
            },

            // trial type 5.2: target left, flash, shift outwards
            {
                stimulus: leftTar,
                jumpedStim: leftTarShiftOut,
                responseButton: leftTarInvisible,
                flash: flashVisible,
                position: 'l',
                shift: 1,
                inwards: 0,
                flashshown: 1,
            },

             // trial type 6: target left, flash, no shift
            {
                stimulus: leftTar,
                jumpedStim: leftTar,
                responseButton: leftTarInvisible,
                flash: flashVisible,
                position: 'l',
                shift: 0,
                inwards: null,
                flashshown: 1,
            },

            // trial type 7.1: target left, no flash, shift inwards
            {
                stimulus: leftTar,
                jumpedStim: leftTarShiftIn,
                responseButton: leftTarInvisible,
                flash: flashInvisible,
                position: 'l',
                shift: 1,
                inwards: 1,
                flashshown: 0,
            },

            // trial type 7.2: target left, no flash, shift outwards
            {
                stimulus: leftTar,
                jumpedStim: leftTarShiftIn,
                responseButton: leftTarInvisible,
                flash: flashInvisible,
                position: 'l',
                shift: 1,
                inwards: 0,
                flashshown: 0,
            },

            // trial type 8: target left, no flash, no shift
            {
                stimulus: leftTar,
                jumpedStim: leftTar,
                responseButton: leftTarInvisible,
                flash: flashInvisible,
                position: 'l',
                shift: 0,
                inwards: null,
                flashshown: 0,
            },
        ];

        let fixation = {
            type: 'html-button-response-touchdown',
            stimulus: [''],
            button_html: fixationPoint,
            choices: [''],
            data: {
                trial_nr: ++trial_nr,
                test_part: 'preFixation',
            },
        };

        let waitAfterFix = {
            type: 'html-keyboard-response',
            stimulus: centralPoint,
            choices: jsPsych.NO_KEYS,
            data: {
                trial_nr: trial_nr,
                test_part: 'earlyFixation',
            },
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([100, 125, 150, 175, 200, 225, 250],
                    1)[0];
            },

            on_finish: function (){
                timer.starttime = jsPsych.totalTime()
            }
        };

        let newPoint = {
            type: "html-button-response-touchdown",
            stimulus: jsPsych.timelineVariable('stimulus'),
            button_html: jsPsych.timelineVariable('responseButton'),
            choices: [''],
            data: {
                trial_nr: trial_nr,
                test_part: 'newPoint',
                position: jsPsych.timelineVariable('position'),
                shift: jsPsych.timelineVariable('shift'),
                inwards: jsPsych.timelineVariable('inwards'),
                flash: jsPsych.timelineVariable('flashshown'),
            },
            trial_duration: function () {
                return jsPsych.randomization.sampleWithReplacement([50, 100, 125, 150, 175, 200],
                    1)[0];
            },

            on_finish: function(data){
              data.touchX = xyCoords.X;
              data.touchY = xyCoords.Y;
            },
        };

        let showFlash = {
            type: 'html-button-response-touchdown',
            stimulus: jsPsych.timelineVariable('flash'),
            prompt: jsPsych.timelineVariable('jumpedStim'),
            button_html: jsPsych.timelineVariable('responseButton'),
            choices: [''],
            data: {
                trial_nr: trial_nr,
                test_part: 'flash',
                position: jsPsych.timelineVariable('position'),
                shift: jsPsych.timelineVariable('shift'),
                inwards: jsPsych.timelineVariable('inwards'),
                flash: jsPsych.timelineVariable('flashshown'),
            },
            trial_duration: 70,

            on_finish: function (data){
                data.touchX = xyCoords.X;
                data.touchY = xyCoords.Y;
                timer.endtime = jsPsych.totalTime();
            }
        };

        let waitResponse = {
            type: "html-button-response-touchdown",
            stimulus: jsPsych.timelineVariable('jumpedStim'),
            button_html: jsPsych.timelineVariable('responseButton'),
            choices: [''],
            trial_duration: 300,
            post_trial_gap: 0,
            data: {
                trial_nr: trial_nr,
                test_part: 'response',
                position: jsPsych.timelineVariable('position'),
                shift: jsPsych.timelineVariable('shift'),
                inwards: jsPsych.timelineVariable('inwards'),
                flash: jsPsych.timelineVariable('flashshown'),
            },

            on_finish: function (data){
                data.touchX = xyCoords.X;
                data.touchY = xyCoords.Y;
                data.full_rt = timer.endtime - timer.starttime + data.rt;
                if (data.rt !== null){
                  responseGiven = true;
                } else {
                    responseGiven = false;
                }
                data.response = responseGiven;
            },
        };

        let feedback = {
            type: "html-button-response-touchdown",
            button_html: [''],
            stimulus: function () { if (responseGiven){return "<p>Well Done.</p>"} else {return "<p>Too slow</p>"}
            },
            trial_duration: 1000,
            post_trial_gap: 500,
            choices: [''],
            data:{
                test_part: 'feedback',
                trial_nr: trial_nr,
            },
           // on_finish: trial_nr,
        };

        // define a training procedure

        let training_procedure = {
            timeline: [fixation, waitAfterFix, newPoint, showFlash, waitResponse, feedback],
            timeline_variables: test_stimuli,
            repetitions: jatos.studyJsonInput.trainingReps,
            randomize_order: true,
        };

        timeline.push(training_procedure);

        // let them know that the training is over
        let instructions = {
            type: 'instructions',
            pages: ["<p>That's the end of the training block.</p>" +
                "<p>&nbsp;</p>"+
                "<p> Press continue to start the experiment.</p>"],
            show_clickable_nav: true,
            button_label_next: 'continue',
            post_trial_gap: 1000,
            data: {
                test_part: 'intro',
            }
        };
        timeline.push(instructions);

        let test_procedure = {
            timeline: [fixation, waitAfterFix, newPoint, showFlash, waitResponse, feedback],
            timeline_variables: test_stimuli,
            repetitions: jatos.studyJsonInput.testReps,
            randomize_order: true,
        };
        timeline.push(test_procedure);


        /* define debrief */

        let debrief_block = {
            type: "html-button-response-touchdown",
            stimulus: function () {

                let trials = jsPsych.data.get().filter({
                    test_part: 'response'
                });
                let rt = Math.round(trials.select('full_rt').mean());

                return "<p>Thanks for your participation!</p>" +
                    "<p>Your average response time was " + rt + "ms.</p>" +
                    "<p>&nbsp;</p>"+
                    "<p>A final question: have you been distracted or concentrated during the experiment?</p>";

            },
            choices: ['distracted', 'concentrated']
        };
        timeline.push(debrief_block);

        /* start the experiment */
        jatos.onLoad(function () {
            jsPsych.init({
                timeline: timeline,
                fullscreen: true,
                on_finish: function() {
                    let resultJson = jsPsych.data.get().json();
                    jatos.submitResultData(resultJson, jatos.startNextComponent);
                },
            });
        });
    </script>
</body>


</html>