<!doctype html>
<!-- Example taken from http://www.jspsych.org/tutorials/rt-task/ and adapted for the use with JATOS -->
<html lang="en">

<head>
    <title>Experiment Block Jumping Dots</title>
    <!-- If you use an older version of JATOS (< 3.3.1) you have to use absolutes path for you assets and jatos.js-->
    <script src="jspsych-6.0.4/jspsych.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-button-response.js"></script>

    <!-- custom scripts -->
    <script src="jspsych-6.0.4/plugins/custom-html-button-response-conditional.js"></script>
    <script src="jspsych-6.0.4/plugins/custom-manual-inhibition-jump.js"></script>
    <link href="styles.css" rel="stylesheet" type="text/css">
    <script src="objects.js"></script>
    <script type= "text/javascript" src="loops.js"></script>
    <script src="common_vars.js"></script>
    <!-- jatos import -->
    <script src="jatos.js"></script>
    <!-- css import -->
    <link href="jspsych-6.0.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <!-- meta prevents zooming in -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" >

</head>

<body bgcolor='gray'>
    
    <script>

        // salute the hacker
        console.log("Welcome to the show!"); 

        // define parameter values for the experiment:
        let nTrials = 1; // the number of trials
        let cFlash = [0,1]; // the flash conditions
        let cJump = [0,1]; // the jump conditions
        let cInwards = [0,1]; // inward/not condition
        let cPosition = ['l', 'r']; // the position condition
        let fixTime = 1000; // how long the central point is maximally touched before the trial starts
        // longer delay than in uploaded version
        let flashTime = 250; //250; // the longest time till the flash occurs after trial start
        let trialDur = 500; // the duration of the experiment (without fixation time)
        let waitAfter = 500; // time to wait after each trial
        let flashDur = 30; // how long to display the flash in ms

        // call the function that sets up all our trials
        let test_stimuli = Jump_loop(nTrials, cFlash, cJump, cInwards, cPosition, fixTime, flashTime, trialDur);

        // let participants confirm that they want to switch to fullscreen
        let confirm_fullscreen = {
            type: "fullscreen",
            message:["<p>Click below to change to fullscreen mode.</p>"],
            fullscreen_mode: true,
            button_label: 'Fullscreen',
            data: {
                test_part: 'fullscreen_request',
            },
        };
        timeline.push(confirm_fullscreen);

        // core trial structure
        let trial = {
            type: 'manual-inhibition-jump', // calls the custom plugin
            centralPoint: centralPoint, // the central point is the same for all trials
            centralButton: invisibleCentralPoint, // the central button is the same for all trials
            sidePoint: jsPsych.timelineVariable('sidePoint'), // the side point is either left or right
            jumpedPoint: jsPsych.timelineVariable('jumpedPoint'), // the jumped point is either left or right and forwards or backwards
            sideButton: jsPsych.timelineVariable('sideButton'), // the side button is either left or right
            flashUp: jsPsych.timelineVariable('flashUp'), // the upper flash is either visible or invisible
            flashDown: jsPsych.timelineVariable('flashDown'), // the lower flash is either visible or invisible
            fixTime: jsPsych.timelineVariable('fixTime'), // the fixation time is a random value between 0 and 1000 ms
            flashTime: jsPsych.timelineVariable('flashTime'), // the flash time is a random value between 0 and 250 ms
            trialDuration: jsPsych.timelineVariable('trialDuration'), // the trial duration is 1000 ms after the first jump
            flashDuration: flashDur, // the flash is shown for 30 ms in each trial
            waitAfter: waitAfter, // the trial waits 500 ms before presenting feedback

            runTrial: function() {
                // this function defines on each trial if it should run or not
                // get the ID of the current trial
                let id_here = jsPsych.timelineVariable('trialID', true);
                // check if we are past time
                if (jatos.studySessionData.totalWaitTime  >= jatos.studySessionData.allowedWaitTime){
                  repeat = false
                } else
                if (repeat_trials.length > 0) {
                  // run the trial if the value is inside the array
                  repeat = repeat_trials.includes(id_here);
                // if there are any values in the repeat trial array
                } else {
                  // this is the first round, we run every trial
                  repeat = true;
                }
                return repeat;
            },

            // save the data from the current trial
            data: {
                test_part: 'trial',
                position: jsPsych.timelineVariable('position'),
                stimJumped: jsPsych.timelineVariable('stimJumps'),
                flashShown: jsPsych.timelineVariable('showFlash'),
                inwards: jsPsych.timelineVariable('inwards'),
                fixTime: jsPsych.timelineVariable('fixTime'),
                flashTime: jsPsych.timelineVariable('flashTime'),
                trialDuration: jsPsych.timelineVariable('trialDuration'),
                trialID: jsPsych.timelineVariable('trialID'),
            },
            // this function is executed after each trial
            on_finish: function (data){
                // check if the response was given too early
                earlyResponse = data.earlyResponse;
                // check if the response was given too late
                lateResponse = data.lateResponse;
                // save a repetition value for the feedback trial
                repeat = data.trialShown;

                // motinor the wait times before the first button press
                if (jatos.studySessionData.totalWaitTime < jatos.studySessionData.allowedWaitTime){
                    jatos.studySessionData.totalWaitTime += data.waitTime;
                }
                // if the response was early or late and the trial was presented in the first place,
                // save the ID of the trial
                if (data.trialShown){
                    if (lateResponse || earlyResponse){
                    T = jsPsych.timelineVariable("trialID", true);
                    repeat_IDs.push(T);
                    }
                }
            },
        };

        // feedback displayed after every trial
        let feedback = {
            type: 'html-button-response-conditional',
            stimulus: function () {
                // evaluate the last trial, and adjust the stimulus that will be returned
                if (earlyResponse) {
                    return "<p>Please keep you finger at fixation till the point jumps!</p>"
                } else if (lateResponse) {
                    return "<p>Too slow!</p>"
                } else {
                    return "<p>Well Done.</p>"
                }
            },
            post_trial_gap: 0, // needs to be zero to avoid waiting times when the trial is skipped
            choices: [''], // don't display choices
            button_html: '', // don't display buttons
            trial_duration: 1500, // display the feedback for 1500 ms
            runTrial: function(){return repeat}, // evaluate if the trial should run or not
            data:{
                test_part: 'feedback',
            },
        };
        
        // define a training procedure
        let test_procedure = {
            timeline: [trial, feedback], // one trial and one feedback will be repeated after each other
            timeline_variables: test_stimuli, // our design structure provides the timeline variables
            repetitions: 1, // our design structure is repeated once
            randomize_order: true, // the order of trials is random
            // this function evaluates if we want to repeat the loop
            // if it evaluates to true, we repeat the full design matrix
            loop_function: function(){
                // save the IDs to be repeated in a new variable
                repeat_trials = repeat_IDs;
                // check if there are any IDs to repeat
                let eval_loop = repeat_IDs.length > 0;
                // reset the repetition array to empty
                repeat_IDs = [];
                // return true or false
                return eval_loop
            },
        };
        timeline.push(test_procedure);

        // define a timeline that is only executed when the allowed wait time is not exceeded
        conditional_timeline = {
            timeline: timeline,
            conditional_function: function(){
                return jatos.studySessionData.totalWaitTime  < jatos.studySessionData.allowedWaitTime;
            },

        }

        /* start the experiment */
        // load jatos - I can use jatos functions after this line
        jatos.onLoad(function () {
            jsPsych.data.addProperties({
                subject: jatos.workerId, // id of the subject
                screenWidth: screen.width, // screen Width in px
                screenHeight: screen.height, // screen Height in px
                userInfo: navigator.userAgent, // some information about the user device
                platform: navigator.platform, // some information about the web browser
                scrPixDepth: screen.pixelDepth, // some information about the pixel structure
                scrColDepth : screen.colorDepth, // some information about the color channels
                scrOrientation: ori, // save the orientation information
                scrResolution: window.devicePixelRatio, // save the pixel ratio
                component: 'Trials_Jump', // name the component
            });

            jsPsych.init({
                timeline: [conditional_timeline, pseudo_trial], // use the timeline to run the experiment
                on_finish: function() {
                    // once the code has run: save the results and call the next jatos component
                    let resultJson = jsPsych.data.get().json();
                    jatos.submitResultData(resultJson, jatos.startNextComponent);
                },
            });
        });
    </script>
</body>


</html>